<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Picture</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // API 키 관리
        const API_KEY_STORAGE_KEY = 'openai_api_key';
        
        function getStoredApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY);
        }

        function setStoredApiKey(apiKey) {
            localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
        }

        // API 에러 처리 유틸리티
        class ApiError extends Error {
            constructor(message, status, details) {
                super(message);
                this.name = 'ApiError';
                this.status = status;
                this.details = details;
            }
        }

        async function handleApiResponse(response) {
            const contentType = response.headers.get('content-type');
            const isJson = contentType && contentType.includes('application/json');
            
            if (!response.ok) {
                const error = isJson ? await response.json() : await response.text();
                let message = '알 수 없는 오류가 발생했습니다.';
                let details = null;

                if (isJson && error.error) {
                    message = error.error.message || error.error;
                    details = error.error.details;
                } else if (typeof error === 'string') {
                    message = error;
                }

                switch (response.status) {
                    case 401:
                        message = 'API 키가 유효하지 않습니다. API 키를 확인해주세요.';
                        break;
                    case 429:
                        message = '요청이 너무 많습니다. 잠시 후 다시 시도해주세요.';
                        break;
                    case 500:
                        message = '서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                        break;
                }

                throw new ApiError(message, response.status, details);
            }

            return response;
        }

        // 수정된 이미지 생성 함수
        async function generateImage(prompt, apiKey) {
            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'OpenAI-Organization': '', // 필요한 경우 조직 ID 추가
                    },
                    body: JSON.stringify({
                        prompt,
                        n: 4,
                        size: '512x512',
                        response_format: 'url',
                        quality: 'standard',
                        model: 'dall-e-2', // 또는 'dall-e-3'
                    })
                });

                const processedResponse = await handleApiResponse(response);
                const data = await processedResponse.json();
                
                if (!data.data || !Array.isArray(data.data)) {
                    throw new Error('응답 데이터 형식이 올바르지 않습니다.');
                }

                return data.data.map(item => item.url);
            } catch (error) {
                if (error instanceof ApiError) {
                    throw error;
                }
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    throw new Error('네트워크 연결을 확인해주세요.');
                }

                console.error('이미지 생성 오류:', error);
                throw new Error('이미지 생성 중 오류가 발생했습니다.');
            }
        }

        // API 키 유효성 검사 함수
        async function validateApiKey(apiKey) {
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                    }
                });

                await handleApiResponse(response);
                return true;
            } catch (error) {
                if (error instanceof ApiError && error.status === 401) {
                    throw new Error('잘못된 API 키입니다. 다시 확인해주세요.');
                }
                throw error;
            }
        }

        // 수정된 API 키 입력 컴포넌트
        function ApiKeyInput({ onSubmit }) {
            const [apiKey, setApiKey] = React.useState('');
            const [error, setError] = React.useState('');
            const [validating, setValidating] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!apiKey.trim()) {
                    setError('API 키를 입력해주세요.');
                    return;
                }

                if (!apiKey.startsWith('sk-')) {
                    setError('유효하지 않은 API 키 형식입니다. "sk-"로 시작하는 키를 입력해주세요.');
                    return;
                }

                setValidating(true);
                setError('');

                try {
                    await validateApiKey(apiKey);
                    setStoredApiKey(apiKey);
                    onSubmit(apiKey);
                } catch (error) {
                    setError(error.message);
                } finally {
                    setValidating(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-8">
                    <div className="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-6">
                            OpenAI API 키 설정
                        </h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    API 키
                                </label>
                                <input
                                    type="password"
                                    value={apiKey}
                                    onChange={(e) => {
                                        setApiKey(e.target.value);
                                        setError('');
                                    }}
                                    className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-400"
                                    placeholder="sk-..."
                                    disabled={validating}
                                />
                                {error && (
                                    <div className="mt-2 text-sm text-red-600">
                                        <p>{error}</p>
                                        {error.includes('API 키') && (
                                            <p className="mt-1">
                                                API 키는 <a 
                                                    href="https://platform.openai.com/api-keys" 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="text-blue-600 hover:text-blue-800"
                                                >
                                                    OpenAI 대시보드
                                                </a>에서 생성할 수 있습니다.
                                            </p>
                                        )}
                                    </div>
                                )}
                            </div>
                            <button
                                type="submit"
                                disabled={validating}
                                className={`w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 transition-colors ${
                                    validating ? 'opacity-50 cursor-not-allowed' : ''
                                }`}
                            >
                                {validating ? '확인 중...' : '확인'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // 상수 정의
        const STYLES = [
            { 
                id: 'fairy-tale', 
                name: '동화', 
                description: '아이들을 위한 환상적이고 마법같은 스타일',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZjVmNSIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNTAiIGZpbGw9IiNmZmQ3ZTUiLz48cGF0aCBkPSJNNzAgMTIwQzkwIDkwIDExMCA5MCAxMzAgMTIwIiBzdHJva2U9IiNmZjk1YjUiIGZpbGw9Im5vbmUiIHN0cm9rZS13aWR0aD0iMyIvPjwvc3ZnPg=='
            },
            { 
                id: 'chalkboard', 
                name: '칠판', 
                description: '교육적이고 클래식한 느낌의 스타일',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzFhMjAyYyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIiBmb250LXNpemU9IjI0Ij5BQkM8L3RleHQ+PC9zdmc+'
            },
            { 
                id: 'watercolor', 
                name: '수채화', 
                description: '부드럽고 예술적인 자연스러운 텍스처',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9ImciPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iI2JiZGVmYiIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2U4ZjVmZSIvPjwvcmFkaWFsR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSJ1cmwoI2cpIi8+PC9zdmc+'
            },
            { 
                id: 'comic', 
                name: '만화', 
                description: '강렬하고 역동적인 윤곽선이 있는 스타일',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik01MCA1MEgxNTBWMTUwSDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjMiIGZpbGw9Im5vbmUiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjIwIiBmaWxsPSIjZmZkNzAwIi8+PC9zdmc+'
            },
            { 
                id: 'minimal', 
                name: '미니멀', 
                description: '단순한 형태의 깔끔하고 현대적인 스타일',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZhZmFmYSIvPjxyZWN0IHg9IjcwIiB5PSI3MCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjMjEyMTIxIi8+PC9zdmc+'
            },
            { 
                id: 'retro', 
                name: '레트로', 
                description: '클래식한 요소가 있는 빈티지 스타일',
                thumbnail: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZWNkMSIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNDAiIGZpbGw9IiNmZjk4NzAiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjIwIiBmaWxsPSIjZmY1NzIyIi8+PC9zdmc+'
            }
        ];

        const CHARACTERS = ['사람', '여성', '아이'];
        const BACKGROUNDS = ['숲', '바다', '도시'];
        const MOODS = ['기쁨', '놀람', '두려움'];

        // 홈 화면
        function Home({ onNavigate }) {
            const buttons = [
                { 
                    id: 'fairy-tale', 
                    title: '동화 일러스트레이션 만들기',
                    preview: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmZmYwZjkiLz48cGF0aCBkPSJNNDAgMTYwQzQwIDkwIDgwIDYwIDEwMCA2MEMxMjAgNjAgMTYwIDkwIDE2MCAxNjAiIGZpbGw9IiNmY2U3ZjMiLz48Y2lyY2xlIGN4PSI2NSIgY3k9IjEwMCIgcj0iMjAiIGZpbGw9IiNmZmIyZGYiLz48Y2lyY2xlIGN4PSIxMzUiIGN5PSIxMDAiIHI9IjIwIiBmaWxsPSIjZmZiMmRmIi8+PHBhdGggZD0iTTY1IDkwUTEwMCAxMjAgMTM1IDkwIiBzdHJva2U9IiNmZjgwY2IiIGZpbGw9Im5vbmUiIHN0cm9rZS13aWR0aD0iMyIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjQwIiByPSIxNSIgZmlsbD0iI2ZmZDdmNSIvPjxwYXRoIGQ9Ik04NSA0MEgxMTVNMTAwIDI1VjU1IiBzdHJva2U9IiNmZjgwY2IiIHN0cm9rZS13aWR0aD0iMyIvPjwvc3ZnPg=='
                },
                { 
                    id: 'educational', 
                    title: '교육용 비주얼 만들기',
                    preview: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmMGYzZmYiLz48cGF0aCBkPSJNMTAwIDQwTDE2MCAxNjBINDBaIiBmaWxsPSIjYmJkZWZiIiBzdHJva2U9IiM2MzkwZmQiIHN0cm9rZS13aWR0aD0iMyIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iMzUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzgyYjFmZiIgc3Ryb2tlLXdpZHRoPSIzIi8+PHJlY3QgeD0iNzAiIHk9IjcwIiB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzQ0OGNmZiIgc3Ryb2tlLXdpZHRoPSIzIiB0cmFuc2Zvcm09InJvdGF0ZSg0NSAxMDAgMTAwKSIvPjxwYXRoIGQ9Ik0xMDAgNDBMMTAwIDE2ME00MCAxMDBMMTYwIDEwMCIgc3Ryb2tlPSIjNjM5MGZkIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1kYXNoYXJyYXk9IjQgNCIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjQwIiByPSI0IiBmaWxsPSIjNDQ4Y2ZmIi8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTYwIiByPSI0IiBmaWxsPSIjNDQ4Y2ZmIi8+PGNpcmNsZSBjeD0iNDAiIGN5PSIxMDAiIHI9IjQiIGZpbGw9IiM0NDhjZmYiLz48Y2lyY2xlIGN4PSIxNjAiIGN5PSIxMDAiIHI9IjQiIGZpbGw9IiM0NDhjZmYiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjQiIGZpbGw9IiM0NDhjZmYiLz48L3N2Zz4='
                },
                { 
                    id: 'social-media', 
                    title: '소셜 미디어 이미지 만들기',
                    preview: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjOGI1Y2Y2Ii8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZWM0ODk5Ii8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9InVybCgjZykiLz48Y2lyY2xlIGN4PSI2MCIgY3k9IjYwIiByPSIyMCIgZmlsbD0iI2ZmZiIgZmlsbC1vcGFjaXR5PSIwLjMiLz48Y2lyY2xlIGN4PSIxNDAiIGN5PSI2MCIgcj0iMjAiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4zIi8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTQwIiByPSIyMCIgZmlsbD0iI2ZmZiIgZmlsbC1vcGFjaXR5PSIwLjMiLz48cGF0aCBkPSJNNjAgNzBMMTAwIDEzME0xNDAgNzBMMTAwIDEzMCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1vcGFjaXR5PSIwLjUiLz48L3N2Zz4='
                },
                { 
                    id: 'card', 
                    title: '일러스트 카드 생성하기',
                    preview: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmMGZkZmYiLz48cmVjdCB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjZTBmN2ZhIiBzdHJva2U9IiM2N2UyZjAiIHN0cm9rZS13aWR0aD0iMyIgcng9IjEyIi8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSIzMCIgZmlsbD0iIzAwYjVkMiIgZmlsbC1vcGFjaXR5PSIwLjUiLz48cGF0aCBkPSJNODUgMTAwSDExNU04NSA4NUgxMTVNODUgMTE1SDExNSIgc3Ryb2tlPSIjMDA4Mzk0IiBzdHJva2Utd2lkdGg9IjMiLz48L3N2Zz4='
                }
            ];

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-8">
                    <div className="max-w-4xl mx-auto">
                        <h1 className="text-4xl font-bold text-center text-gray-800 mb-12">
                            Story Picture
                        </h1>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {buttons.map(button => (
                                <button
                                    key={button.id}
                                    onClick={() => onNavigate('style-selection', { type: button.id })}
                                    className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:scale-105 overflow-hidden"
                                >
                                    <div className="h-48 bg-gray-50">
                                        <img 
                                            src={button.preview}
                                            alt={button.title}
                                            className="w-full h-full object-cover"
                                        />
                                    </div>
                                    <div className="p-6">
                                        <h2 className="text-xl font-semibold text-gray-700 mb-2">
                                            {button.title}
                                        </h2>
                                        <p className="text-gray-500">
                                            클릭하여 {button.title.toLowerCase()} 시작하기
                                        </p>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // 스타일 선택 화면
        function StyleSelection({ params, onNavigate }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex items-center mb-8">
                            <button
                                onClick={() => onNavigate('home')}
                                className="p-2 text-gray-600 hover:text-gray-800 hover:bg-white rounded-full transition-colors"
                                aria-label="뒤로가기"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h1 className="text-4xl font-bold text-gray-800 flex-1 text-center">
                                스타일 선택하기
                            </h1>
                            <div className="w-10"></div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {STYLES.map(style => (
                                <button
                                    key={style.id}
                                    onClick={() => onNavigate('text-input', { ...params, style: style.id })}
                                    className="bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300"
                                >
                                    <div className="h-48 bg-gray-50">
                                        <img 
                                            src={style.thumbnail}
                                            alt={style.name}
                                            className="w-full h-full object-cover"
                                        />
                                    </div>
                                    <div className="p-4">
                                        <h3 className="text-xl font-semibold text-gray-700 mb-2">
                                            {style.name}
                                        </h3>
                                        <p className="text-gray-500">
                                            {style.description}
                                        </p>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // 텍스트 입력 화면
        function TextInput({ params, onNavigate }) {
            const [description, setDescription] = React.useState('');
            const [selectedCharacters, setSelectedCharacters] = React.useState([]);
            const [selectedBackgrounds, setSelectedBackgrounds] = React.useState([]);
            const [selectedMoods, setSelectedMoods] = React.useState([]);

            const toggleSelection = (item, list, setList) => {
                if (list.includes(item)) {
                    setList(list.filter(i => i !== item));
                } else {
                    setList([...list, item]);
                }
            };

            const handleGenerate = () => {
                onNavigate('result', {
                    ...params,
                    description,
                    characters: selectedCharacters,
                    backgrounds: selectedBackgrounds,
                    moods: selectedMoods
                });
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-8">
                    <div className="max-w-4xl mx-auto">
                        <div className="flex items-center mb-8">
                            <button
                                onClick={() => onNavigate('style-selection', { type: params.type })}
                                className="p-2 text-gray-600 hover:text-gray-800 hover:bg-white rounded-full transition-colors"
                                aria-label="뒤로가기"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h1 className="text-4xl font-bold text-gray-800 flex-1 text-center">
                                장면 설명하기
                            </h1>
                            <div className="w-10"></div>
                        </div>
                        
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                            <textarea
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder="생성하고 싶은 장면을 설명해주세요..."
                                className="w-full h-32 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400"
                            />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-semibold mb-4">캐릭터</h2>
                                {CHARACTERS.map(character => (
                                    <label key={character} className="flex items-center mb-2">
                                        <input
                                            type="checkbox"
                                            checked={selectedCharacters.includes(character)}
                                            onChange={() => toggleSelection(character, selectedCharacters, setSelectedCharacters)}
                                            className="mr-2"
                                        />
                                        {character}
                                    </label>
                                ))}
                            </div>

                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-semibold mb-4">배경</h2>
                                {BACKGROUNDS.map(background => (
                                    <label key={background} className="flex items-center mb-2">
                                        <input
                                            type="checkbox"
                                            checked={selectedBackgrounds.includes(background)}
                                            onChange={() => toggleSelection(background, selectedBackgrounds, setSelectedBackgrounds)}
                                            className="mr-2"
                                        />
                                        {background}
                                    </label>
                                ))}
                            </div>

                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h2 className="text-xl font-semibold mb-4">분위기</h2>
                                {MOODS.map(mood => (
                                    <label key={mood} className="flex items-center mb-2">
                                        <input
                                            type="checkbox"
                                            checked={selectedMoods.includes(mood)}
                                            onChange={() => toggleSelection(mood, selectedMoods, setSelectedMoods)}
                                            className="mr-2"
                                        />
                                        {mood}
                                    </label>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-center">
                            <button
                                onClick={handleGenerate}
                                disabled={!description.trim()}
                                className="px-8 py-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                            >
                                이미지 생성하기
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // 저장된 이미지 관리
        const SAVED_IMAGES_KEY = 'saved_images';

        function getSavedImages() {
            const saved = localStorage.getItem(SAVED_IMAGES_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        function saveImages(images, params) {
            const saved = getSavedImages();
            const newEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                images,
                params,
                style: STYLES.find(s => s.id === params.style)
            };
            saved.unshift(newEntry);
            localStorage.setItem(SAVED_IMAGES_KEY, JSON.stringify(saved));
            return newEntry;
        }

        // 이미지 다운로드 유틸리티
        async function downloadImages(images, format = 'zip') {
            if (format === 'zip') {
                const zip = new JSZip();
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                
                for (let i = 0; i < images.length; i++) {
                    const response = await fetch(images[i]);
                    const blob = await response.blob();
                    zip.file(`image-${i + 1}.png`, blob);
                }
                
                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, `generated-images-${timestamp}.zip`);
            } else {
                const link = document.createElement('a');
                link.href = images[0];
                link.download = `generated-image.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 저장된 이미지 갤러리 컴포넌트
        function SavedGallery({ onClose }) {
            const [savedImages, setSavedImages] = React.useState(getSavedImages());
            const [selectedEntry, setSelectedEntry] = React.useState(null);

            const handleDelete = (id) => {
                const updated = savedImages.filter(entry => entry.id !== id);
                localStorage.setItem(SAVED_IMAGES_KEY, JSON.stringify(updated));
                setSavedImages(updated);
            };

            const handleDownload = async (images) => {
                await downloadImages(images);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">저장된 이미지</h2>
                            <button
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                닫기
                            </button>
                        </div>

                        {savedImages.length === 0 ? (
                            <p className="text-center text-gray-500 py-8">
                                저장된 이미지가 없습니다.
                            </p>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {savedImages.map(entry => (
                                    <div key={entry.id} className="bg-gray-50 rounded-lg p-4">
                                        <div className="grid grid-cols-2 gap-2 mb-4">
                                            {entry.images.map((img, idx) => (
                                                <img
                                                    key={idx}
                                                    src={img}
                                                    alt={`Generated ${idx + 1}`}
                                                    className="w-full h-32 object-cover rounded"
                                                />
                                            ))}
                                        </div>
                                        <div className="space-y-2">
                                            <p className="text-sm text-gray-600">
                                                스타일: {entry.style.name}
                                            </p>
                                            <p className="text-sm text-gray-600">
                                                생성일: {new Date(entry.timestamp).toLocaleString()}
                                            </p>
                                            <div className="flex justify-between">
                                                <button
                                                    onClick={() => handleDownload(entry.images)}
                                                    className="text-blue-600 hover:text-blue-800 text-sm"
                                                >
                                                    다운로드
                                                </button>
                                                <button
                                                    onClick={() => handleDelete(entry.id)}
                                                    className="text-red-600 hover:text-red-800 text-sm"
                                                >
                                                    삭제
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // 수정된 Result 컴포넌트
        function Result({ params, onNavigate }) {
            const [images, setImages] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [showGallery, setShowGallery] = React.useState(false);
            const [saved, setSaved] = React.useState(false);

            const handleError = (error) => {
                let errorMessage = error.message;

                if (error instanceof ApiError) {
                    if (error.status === 401) {
                        // API 키가 유효하지 않은 경우 API 키 입력 화면으로 이동
                        localStorage.removeItem(API_KEY_STORAGE_KEY);
                        onNavigate('api-key', params);
                        return;
                    }
                }

                setError(errorMessage);
            };

            React.useEffect(() => {
                const generateImages = async () => {
                    try {
                        setLoading(true);
                        setError(null);

                        const apiKey = getStoredApiKey();
                        if (!apiKey) {
                            throw new Error('API 키가 설정되지 않았습니다.');
                        }

                        const style = STYLES.find(s => s.id === params.style);
                        const prompt = `
                            ${params.description}. 
                            스타일: ${style.name}. 
                            ${params.characters.length > 0 ? `등장인물: ${params.characters.join(', ')}` : ''}
                            ${params.backgrounds.length > 0 ? `배경: ${params.backgrounds.join(', ')}` : ''}
                            ${params.moods.length > 0 ? `분위기: ${params.moods.join(', ')}` : ''}
                        `.trim();

                        const imageUrls = await generateImage(prompt, apiKey);
                        setImages(imageUrls);
                    } catch (err) {
                        handleError(err);
                    } finally {
                        setLoading(false);
                    }
                };

                generateImages();
            }, [params]);

            const handleSave = () => {
                saveImages(images, params);
                setSaved(true);
                setTimeout(() => setSaved(false), 2000);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-8">
                        <div className="max-w-6xl mx-auto text-center">
                            <h1 className="text-4xl font-bold text-gray-800 mb-8">
                                이미지 생성 중...
                            </h1>
                            <div className="animate-pulse">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                    {[1, 2, 3, 4].map((i) => (
                                        <div key={i} className="bg-white rounded-xl shadow-lg overflow-hidden">
                                            <div className="h-64 bg-gray-200"></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-8">
                        <div className="max-w-6xl mx-auto text-center">
                            <h1 className="text-4xl font-bold text-gray-800 mb-8">
                                오류 발생
                            </h1>
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-8">
                                <p className="font-bold mb-2">이미지 생성 실패</p>
                                <p>{error}</p>
                            </div>
                            <div className="flex justify-center gap-4">
                                <button
                                    onClick={() => window.location.reload()}
                                    className="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-colors"
                                >
                                    다시 시도
                                </button>
                                <button
                                    onClick={() => onNavigate('text-input', { type: params.type, style: params.style })}
                                    className="px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition-colors"
                                >
                                    설명 수정
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-800">
                                생성된 이미지
                            </h1>
                            <button
                                onClick={() => setShowGallery(true)}
                                className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                            >
                                저장된 이미지 보기
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            {images.map((image, index) => (
                                <div key={index} className="bg-white rounded-xl shadow-lg overflow-hidden">
                                    <img 
                                        src={image} 
                                        alt={`Generated ${index + 1}`}
                                        className="w-full h-64 object-cover"
                                    />
                                    <div className="p-4 flex justify-end space-x-2">
                                        <button
                                            onClick={() => downloadImages([image], 'single')}
                                            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                                        >
                                            다운로드
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="flex flex-wrap justify-center gap-4">
                            <button
                                onClick={() => onNavigate('style-selection', { type: params.type })}
                                className="px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition-colors"
                            >
                                스타일 변경
                            </button>
                            <button
                                onClick={() => onNavigate('text-input', { type: params.type, style: params.style })}
                                className="px-6 py-3 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition-colors"
                            >
                                설명 수정
                            </button>
                            <button
                                onClick={() => downloadImages(images)}
                                className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                            >
                                전체 다운로드
                            </button>
                            <button
                                onClick={handleSave}
                                disabled={saved}
                                className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
                                    saved 
                                        ? 'bg-green-500 text-white cursor-not-allowed'
                                        : 'bg-green-600 text-white hover:bg-green-700'
                                }`}
                            >
                                {saved ? '저장됨' : '저장하기'}
                            </button>
                        </div>
                    </div>

                    {showGallery && (
                        <SavedGallery onClose={() => setShowGallery(false)} />
                    )}
                </div>
            );
        }

        // 메인 앱 컴포넌트
        function App() {
            const [currentScreen, setCurrentScreen] = React.useState('home');
            const [params, setParams] = React.useState({});
            const [apiKey, setApiKey] = React.useState(getStoredApiKey());

            const handleNavigate = (screen, newParams = {}) => {
                if (!apiKey && screen === 'result') {
                    setParams(newParams);
                    setCurrentScreen('api-key');
                    return;
                }
                setCurrentScreen(screen);
                setParams(newParams);
            };

            const handleApiKeySubmit = (key) => {
                setApiKey(key);
                setCurrentScreen('result');
            };

            const renderScreen = () => {
                switch (currentScreen) {
                    case 'home':
                        return <Home onNavigate={handleNavigate} />;
                    case 'style-selection':
                        return <StyleSelection params={params} onNavigate={handleNavigate} />;
                    case 'text-input':
                        return <TextInput params={params} onNavigate={handleNavigate} />;
                    case 'result':
                        return <Result params={params} onNavigate={handleNavigate} />;
                    case 'api-key':
                        return <ApiKeyInput onSubmit={handleApiKeySubmit} />;
                    default:
                        return <Home onNavigate={handleNavigate} />;
                }
            };

            return renderScreen();
        }

        // 앱 렌더링
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html> 